<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<link href="https://cdn.bootcss.com/twitter-bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script>
var is_nwjs = (typeof nw != 'undefined');
var is_nwjsdev = is_nwjs && (window.navigator.plugins.namedItem('Native Client') !== null);
function empty(o) {
    return o==null || o==undefined || o==0 || o.length==0;
}
if (is_nwjsdev)
    nw.Window.get().showDevTools();

mon_win = null;
$(document).ready(function(){
    mon_win = window.frames['frame_monitor'];
    console.log('检查是否已登录进报警台');
    setInterval(function(){
        refreshAlertIfLoggedIn();
    }, 1000);
    refreshAlertIfLoggedIn();
});
// 检查是否已登录，如果已登录则检查是否需要刷新报警列表
var first_switch_to_not_logged_in = 0;
var last_try_refresh_alert = 0;
function refreshAlertIfLoggedIn() {
    var ts = (new Date()).getTime()/1000;
    if (typeof(mon_win.logged_in)!='undefined' && mon_win.logged_in) {
        // 已登录
        //console.log('已登录');
        // 显示新版报警列表
        $('#main_con').show();
        // 如果超过N秒未尝试刷新，则刷新
        if (ts-last_try_refresh_alert>6) {
            last_try_refresh_alert = ts;
            mon_win.loadAlert(window);
        }
    }
    else {
        // 未登录
        //console.log('未登录');
        // 如果超过20秒处于未登录，则显示登录界面
        if (ts - first_switch_to_not_logged_in>20) {
            if ($('#main_con:visible').length) {
                first_switch_to_not_logged_in = ts;
                $('#main_con').hide();
                window.frames['frame_monitor'].location.reload();
            }
        }
    }
}
// 发送桌面通知
function desktopNotify(rec) {
    var t = rec.mixname;
    var b = rec.alertmsg;
    b = b.replace(/\{.*\}/,'');
    console.log('桌面通知: 【'+t+'】'+b);
    var ntf = new Notification(t,{body:b});
    ntf.rec = rec;
    ntf.onclick = function(e) {
        nw.Window.get().focus();
        blinkAlert(ntf.rec);
        ntf.close();
    }
}
// 更新告警列表
var prevAlertList = null;
var latestAlertList = null;
function updateAlertList(list) {
    console.log('更新最新的报警数据');
    //console.log(list);
    // 展示列表
    prevAlertList = latestAlertList;
    latestAlertList = list;
    refreshAlertList(latestAlertList);
    // 发送桌面通知
    if (prevAlertList==null) {
        notifyRecent(latestAlertList);
    } else {
        notifyDiff(prevAlertList, latestAlertList);
    }
}
// 刷新报警列表
function refreshAlertList(list) {
    var ts = (new Date()).getTime()/1000;
    var dbox = $('#alert_list_box');
    // 刷新报警内容
    for (var i=0; i<list.length; ++i) {
        var rec = list[i];
        var did = `alert_${rec.seqid}`;
        var dalt = $(`#${did}`);
        if (dalt.length==0) {
            var start = new Date();
            start.setTime(rec.alertstarttime*1000);
            var latest = new Date();
            latest.setTime(rec.latestalerttime*1000);
            var alert_level = (ts-rec.latestalerttime<600)? 'danger':'warning';
            dalt = $(`<div class="alert alert-${alert_level} shadow" role="alert" latestalerttime="${rec.latestalerttime}" id="${did}"></div>`);
            part1_txt = rec.alertmsg.substr(0, rec.alertmsg.indexOf('{'));
            part2_txt = rec.alertmsg.substring(rec.alertmsg.indexOf('{'), rec.alertmsg.indexOf('}')+1);
            part3_txt = rec.alertmsg.substr(rec.alertmsg.indexOf('}')+1);
            var dlink = $(`<a target="_blank"></a>`).text(part2_txt);
            if (rec.mixtype==1)
                dlink.attr('href', `javascript:browse("http://monitor.server.com/link/graph/servid:${rec.mixid}")`);
            else
                dlink.attr('href', `javascript:browse("http://monitor.server.com/link/graph/viewid:${rec.mixid}")`);
            dalt.append($(`<span>${part1_txt}</span>`));
            dalt.append(dlink);
            dalt.append($(`<span>${part3_txt}</span>`));
            dalt.append($(`<span class="font-italic" style="padding:5px;" name="timeago">(${timeAgo(ts - rec.latestalerttime)}第${rec.alertcount}次告警)</span>`));
            if (Math.random()<0.5)
                dbox.append(dalt);
            else
                dbox.prepend(dalt);
        } else {
            dalt.find('[name=timeago]').text(`(${timeAgo(ts - rec.latestalerttime)}第${rec.alertcount}次告警)`);
        }
    }
    // 按报警从新到旧排序，最多排200次
    for (var i=0; i<200; ++i) {
        if (0==resortOneOfAlertList())
            break;
    }
}
// 重新对报警列表进行排序，每次只调整一个报警，并且排名只调整一位
function resortOneOfAlertList() {
    var dbox = $('#alert_list_box');
    var dlist = dbox.children('[latestalerttime]');
    var last_ts = (new Date()).getTime()/1000;
    var last_dalt = null;
    for (var i=0; i<dlist.length; ++i) {
        var dalt = $(dlist[i]);
        var ts = parseInt(dalt.attr('latestalerttime'));
        if (ts > last_ts && last_dalt!=null) {
            dalt.remove();
            console.log('排序发生');
            last_dalt.before(dalt);
            return 1;
        }
        last_ts = ts;
        last_dalt = dalt;
    }
    return 0;
}
// 计算`多少时间以前`的字符串
function timeAgo(sec) {
    sec = parseInt(sec);
    if (sec<=0)
        sec = 1;
    var txt = `${sec}秒前`;
    if (sec>=2*3600)
        txt = `${parseInt(sec/3600)}小时前`;
    else if (sec>=300)
        txt = `${parseInt(sec/60)}分钟前`;
    return txt;
}
// 将最新的报警做桌面通知
function notifyRecent(list) {
    var ts = (new Date()).getTime()/1000;
    for (var i=0; i<list.length; ++i) {
        var rec = list[i];
        // 60秒内的才处理
        if(ts-rec.latestalerttime<60) {
            desktopNotify(rec);
        }
    }
}
// 比较新旧报警列表，将新报警展示出来
function notifyDiff(old_list, new_list) {
    for (var i=0; i<new_list.length; ++i) {
        var rec = new_list[i];
        var found = 0;
        for (var i=0; i<old_list.length; ++i) {
            if (old_list[i].seqid==rec.seqid) {
                found = 1;
                break;
            }
        }
        rec.found_in_old = found;
    }
    for (var i=0; i<new_list.length; ++i) {
        var rec = new_list[i];
        if (rec.found_in_old==0) {
            desktopNotify(rec);
        }
    }
}
function browse(url) {
    nw.Shell.openExternal(url);
}
function blinkAlert(rec) {
    console.log(`闪动 ${rec.alertmsg}`);
    var did = `alert_${rec.seqid}`;
    var dalt = $(`#${did}`);
    console.log(dalt.length);
    dalt.addClass('border-danger text-danger');
    var intl = setInterval(function(){dalt.toggleClass('border-danger text-danger')},300);
    setTimeout(function(){clearInterval(intl); dalt.removeClass('border-danger text-danger');},6000);
}
</script>
</head>
<body>
    <iframe id="frame_monitor" name="frame_monitor" style="width:100%;height:100%;position:absolute;z-index:0;" src="http://monitor.server.com"></iframe>
    <div id="main_con" style="width:100%;height:100%;position:absolute;z-index:1; background:azure;">
        <div id="alert_list_box" style="padding:5px;"></div>
    </div>
    <button type="button" class="btn btn-primary btn-sm" style="position:absolute;z-index:2;bottom:0px;right:0px;" onclick="nw.Window.get().reload();">Reload</button>
</body>
</html>